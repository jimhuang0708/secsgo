<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SECS/GEM JSON Builder</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
.node-box {
    border-left: 2px solid #555;
    padding-left: 15px;
    margin-top: 12px;
}

.node-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.children {
    margin-top: 8px;
    padding-left: 15px;
    border-left: 1px solid #aaa;
}
</style>
</head>

<body class="p-4">

<h3>SECS/GEM JSON Builder</h3>

<div class="mb-3">
    <label>Stream</label>
    <input id="streamInput" type="number" class="form-control" value="1">
</div>

<div class="mb-3">
    <label>Function</label>
    <input id="functionInput" type="number" class="form-control" value="3">
</div>

<hr>

<h5>Data Item</h5>
<div id="rootContainer"></div>

<button id="generateBtn" class="btn btn-primary mt-3">Generate JSON</button>

<hr>

<h5 class="mt-4">Load JSON → UI</h5>
<textarea id="jsonInput" class="form-control" rows="8" placeholder="Paste JSON here..."></textarea>
<button id="loadBtn" class="btn btn-success mt-2">Load JSON</button>

<pre id="output" class="bg-dark text-light p-3 mt-3" style="min-height:200px;"></pre>

<script>
const DATA_TYPES = [
    "U1","U2","U4","U8",
    "I1","I2","I4","I8",
    "A","BOOLEAN","B",
    "F4","F8",
    "L"
];

/* -----------------------------
   Node UI Builder
----------------------------- */
function createNode() {
    return $(`
        <div class="node-box">

            <div class="node-row">

                <select class="form-select type-select" style="width:150px;">
                    <option value="">--Type--</option>
                    ${DATA_TYPES.map(t=>`<option value="${t}">${t}</option>`).join("")}
                </select>

                <div class="input-area flex-grow-1"></div>

                <button class="btn btn-secondary btn-sm add-child" style="display:none;">+</button>

                <button class="btn btn-danger btn-sm remove-node">X</button>

            </div>

            <div class="children"></div>
        </div>
    `);
}

/* Init root */
$("#rootContainer").html("").append(createNode());


/* -----------------------------
   Handle type change
----------------------------- */
$(document).on("change", ".type-select", function () {
    const box = $(this).closest(".node-box");
    const area = box.find(".input-area");
    const children = box.find(".children");
    const type = $(this).val();

    area.empty();
    children.empty();
    box.find(".add-child").hide();

    if (["U1","U2","U4","U8","I1","I2","I4","I8","F4","F8"].includes(type)) {
        area.append(`<input class="form-control value-numbers" placeholder="1 2 3">`);
    }
    else if (type === "A") {
        area.append(`<input class="form-control value-ascii" placeholder="Some text">`);
    }
    else if (type === "BOOLEAN") {
        area.append(`<input class="form-control value-bools" placeholder="true false">`);
    }
    else if (type === "B") {
        area.append(`<input class="form-control value-bytes" placeholder="FF EE DD">`);
    }
    else if (type === "L") {
        box.find(".add-child").show();
    }
});

/* Add Child */
$(document).on("click", ".add-child", function () {
    $(this).closest(".node-box").find("> .children").append(createNode());
});

/* Remove Node */
$(document).on("click", ".remove-node", function () {
    $(this).closest(".node-box").remove();
});

/* -----------------------------
   Build JSON Recursively
----------------------------- */
function buildNode($node) {
    const type = $node.find("> .node-row .type-select").val();
    if (!type) return null;

    let obj = { type };

    if (["U1","U2","U4","U8","I1","I2","I4","I8","F4","F8"].includes(type)) {
        obj.values = $node.find(".value-numbers").val().trim().split(/\s+/).map(Number);
    }
    else if (type === "A") {
        obj.value = $node.find(".value-ascii").val();
    }
    else if (type === "BOOLEAN") {
        obj.bools = $node.find(".value-bools").val().trim().split(/\s+/).map(v => v==="true");
    }
    else if (type === "B") {
        obj.bytes = $node.find(".value-bytes").val();
    }
    else if (type === "L") {
        obj.items = [];
        $node.find("> .children > .node-box").each(function () {
            obj.items.push(buildNode($(this)));
        });
    }

    return obj;
}

$("#generateBtn").click(function () {
    const root = $("#rootContainer .node-box").first();
    const dataItem = buildNode(root);

    $("#output").text(JSON.stringify({
        stream: parseInt($("#streamInput").val()),
        function: parseInt($("#functionInput").val()),
        dataitem: dataItem
    }, null, 4));
});

/* -----------------------------
   JSON → UI Loader
----------------------------- */
function loadNodeToUI(nodeData, container) {
    const node = createNode();
    container.append(node);

    // set type
    const typeSelect = node.find("> .node-row .type-select");
    typeSelect.val(nodeData.type).trigger("change");

    const area = node.find(".input-area");

    if (nodeData.type === "A") {
        area.find(".value-ascii").val(nodeData.value || "");
    }
    else if (["U1","U2","U4","U8","I1","I2","I4","I8","F4","F8"].includes(nodeData.type)) {
        area.find(".value-numbers").val((nodeData.values || []).join(" "));
    }
    else if (nodeData.type === "BOOLEAN") {
        area.find(".value-bools").val((nodeData.bools || []).map(v=>v?"true":"false").join(" "));
    }
    else if (nodeData.type === "B") {
        area.find(".value-bytes").val(nodeData.bytes || "");
    }
    else if (nodeData.type === "L") {
        let childContainer = node.find("> .children");
        (nodeData.items || []).forEach(c => loadNodeToUI(c, childContainer));
    }
}

$("#loadBtn").click(function () {
    try {
        let json = JSON.parse($("#jsonInput").val().trim());

        $("#streamInput").val(json.stream);
        $("#functionInput").val(json.function);

        $("#rootContainer").html("");

        loadNodeToUI(json.dataitem, $("#rootContainer"));

        alert("JSON Loaded Successfully!");
    }
    catch (e) {
        alert("Invalid JSON!");
        console.error(e);
    }
});
</script>

</body>
</html>
